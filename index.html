<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Philly Provider Map</title>
    <style>
      html,
      body {
        height: 100%;
        margin: 0;
        padding: 0;
        font-family: Arial, sans-serif;
      }

      #map {
        height: 100%;
        width: 100%;
      }

      /* Bottom-left control stack */
      #controls-wrapper {
        position: absolute;
        bottom: 16px;
        left: 16px;
        display: flex;
        flex-direction: column;
        gap: 8px;
        z-index: 5;
      }

      .control-box {
        background: rgba(255, 255, 255, 0.95);
        padding: 8px 10px;
        border-radius: 6px;
        box-shadow: 0 1px 4px rgba(0, 0, 0, 0.3);
        font-size: 12px;
        max-width: 260px;
      }

      .control-title {
        font-weight: bold;
        margin-bottom: 4px;
        font-size: 13px;
      }

      /* Legend styles */
      #legend .legend-row {
        display: flex;
        align-items: center;
        margin-bottom: 2px;
      }
      .legend-color {
        width: 10px;
        height: 10px;
        border-radius: 50%;
        margin-right: 6px;
        border: 1px solid #555;
      }

      .legend-size-row {
        display: flex;
        flex-direction: column;
        align-items: flex-start;
        gap: 4px;
        margin-top: 4px;
      }

      .legend-size-item {
        display: flex;
        align-items: center;
      }

      .legend-size-circle {
        border-radius: 50%;
        border: 1px solid #555;
        margin-right: 6px;
      }

      /* Stats panel */
      #stats-box .stats-line {
        margin-bottom: 2px;
      }

      .stats-type-row {
        display: flex;
        align-items: flex-start;
        margin-bottom: 2px;
      }

      .stats-dot {
        width: 8px;
        height: 8px;
        border-radius: 50%;
        margin-right: 6px;
        margin-top: 3px;
        border: 1px solid #555;
        flex-shrink: 0;
      }
    </style>
  </head>

  <body>
    <div id="map"></div>

    <div id="controls-wrapper">
      <!-- Filter -->
      <div id="filter-box" class="control-box">
        <div class="control-title">Filter</div>
        <label>
          Min members:
          <input id="minMembersInput" type="number" min="0" step="10" value="0" />
        </label>
        <button id="applyFilterBtn">Apply</button>
      </div>

      <!-- Stats -->
      <div id="stats-box" class="control-box">
        <div class="control-title">Visible Providers</div>
        <div id="stats-content">
          Providers: 0<br />
          Total Members: 0
        </div>
      </div>

      <!-- Legend -->
      <div id="legend" class="control-box">
        <div class="control-title">Legend</div>

        <div style="font-weight:bold; margin-bottom:4px;">By Affiliation</div>
        
        <div class="legend-row">
          <span class="legend-color" style="background:#1f78b4;"></span>Main Line
        </div>
        <div class="legend-row">
          <span class="legend-color" style="background:#e31a1c;"></span>Jefferson
        </div>
        <div class="legend-row">
          <span class="legend-color" style="background:#33a02c;"></span>St. Luke's
        </div>
        <div class="legend-row">
          <span class="legend-color" style="background:#ff7f00;"></span>Tandigm
        </div>
        <div class="legend-row">
          <span class="legend-color" style="background:#6a3d9a;"></span>UPenn
        </div>
        <div class="legend-row">
          <span class="legend-color" style="background:#bbbbbb;"></span>Other
        </div>

        <div style="margin-top:6px; font-weight:bold;">
          Attributed Members = Circle Size
        </div>

        <div class="legend-size-row">
          <div class="legend-size-item">
            <span id="legend-min-circle" class="legend-size-circle" style="width:8px; height:8px;"></span>
            <span id="legend-min-text">Smallest: N/A</span>
          </div>
          <div class="legend-size-item">
            <span id="legend-max-circle" class="legend-size-circle" style="width:20px; height:20px;"></span>
            <span id="legend-max-text">Largest: N/A</span>
          </div>
        </div>
      </div>
    </div>

    <!-- MAIN SCRIPT -->
    <script>
      let map;
      let markers = [];
      let allData = [];
      let infoWindow;
      let minPatientsGlobal = null;
      let maxPatientsGlobal = null;

      function getAffiliationColor(aff) {
        if (!aff) return "#bbbbbb";

        const a = aff.toLowerCase();
        if (a.includes("main line")) return "#1f78b4";
        if (a.includes("jefferson")) return "#e31a1c";
        if (a.includes("st. luke")) return "#33a02c";
        if (a.includes("tandigm")) return "#ff7f00";
        if (a.includes("penn")) return "#6a3d9a";

        return "#bbbbbb";
      }

      function computeRadius(val, minVal, maxVal) {
        if (minVal === maxVal) return 10;
        return 8 + ((val - minVal) / (maxVal - minVal)) * 22;
      }

      function initMap() {
        map = new google.maps.Map(document.getElementById("map"), {
          center: { lat: 40.0, lng: -75.2 },
          zoom: 8,
        });

        infoWindow = new google.maps.InfoWindow();

        fetch("data.geojson")
          .then((res) => res.json())
          .then((geojson) => {
            allData = geojson.features;
            createMarkers();
            setupFilter();
          })
          .catch((err) => {
            console.error(err);
            alert("Could not load data.geojson. Check file name or format.");
          });
      }

      function createMarkers() {
        markers.forEach((m) => m.setMap(null));
        markers = [];

        let minVal = Infinity;
        let maxVal = -Infinity;

        allData.forEach((f) => {
          const v = f.properties["Member Attribution"];
          if (typeof v === "number") {
            if (v < minVal) minVal = v;
            if (v > maxVal) maxVal = v;
          }
        });

        minPatientsGlobal = minVal;
        maxPatientsGlobal = maxVal;

        document.getElementById("legend-min-text").textContent = "Smallest: " + minVal;
        document.getElementById("legend-max-text").textContent = "Largest: " + maxVal;

        allData.forEach((feature) => {
          const coords = feature.geometry.coordinates;
          const props = feature.properties;

          const lat = coords[1];
          const lng = coords[0];

          const radius = computeRadius(
            props["Member Attribution"],
            minVal,
            maxVal
          );

          const marker = new google.maps.Circle({
            strokeColor: getAffiliationColor(props.Affiliation),
            strokeOpacity: 0.8,
            strokeWeight: 1,
            fillColor: getAffiliationColor(props.Affiliation),
            fillOpacity: 0.6,
            map,
            center: { lat, lng },
            radius: radius * 40,
          });

          marker.meta = props;

          marker.addListener("click", () => {
            const html = `
              <div>
                <b>${props["Provider / Facility"]}</b><br/>
                ${props.Address}, ${props.City}, ${props.State} ${props.Zip}<br/>
                Type: ${props.Type}<br/>
                Member Attribution: ${props["Member Attribution"]}
              </div>
            `;

            infoWindow.setContent(html);
            infoWindow.setPosition({ lat, lng });
            infoWindow.open(map);
          });

          markers.push(marker);
        });

        updateStats();
      }

      function setupFilter() {
        document.getElementById("applyFilterBtn").onclick = applyFilter;
      }

      function applyFilter() {
        const minVal = parseInt(
          document.getElementById("minMembersInput").value
        );

        markers.forEach((m) => {
          if (m.meta["Member Attribution"] >= minVal) {
            m.setMap(map);
          } else {
            m.setMap(null);
          }
        });

        updateStats();
      }

      function updateStats() {
        let count = 0;
        let total = 0;

        markers.forEach((m) => {
          if (m.getMap()) {
            count++;
            total += m.meta["Member Attribution"];
          }
        });

        document.getElementById("stats-content").innerHTML =
          `Providers: ${count}<br>Total Members: ${total}`;
      }
    </script>

    <!-- GOOGLE MAPS API LOAD -->
    <script
      async
      defer
      src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDA3kRQCQIWUxnsE1b0__QSyCfFKkHwN8A&callback=initMap"
    ></script>
  </body>
</html>

