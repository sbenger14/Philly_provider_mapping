<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Philly Provider Map</title>

  <style>
    html, body {
      height: 100%;
      margin: 0;
      padding: 0;
      font-family: Arial, sans-serif;
    }

    #map {
      height: 100%;
      width: 100%;
    }

    /* Control boxes (like AllCare map) */
    #legend, #info-box {
      position: absolute;
      bottom: 20px;
      left: 20px;
      background: rgba(255,255,255,0.95);
      padding: 12px;
      border-radius: 8px;
      font-size: 14px;
      box-shadow: 0px 2px 6px rgba(0,0,0,0.3);
      width: 240px;
    }

    #legend {
      bottom: 20px;
    }

    #info-box {
      bottom: 200px;
    }

    .legend-title {
      font-weight: bold;
      margin-bottom: 6px;
      margin-top: 4px;
    }

    .legend-item {
      display: flex;
      align-items: center;
      margin-bottom: 4px;
    }

    .legend-color {
      width: 14px;
      height: 14px;
      border-radius: 50%;
      margin-right: 6px;
      border: 1px solid #555;
    }
  </style>
</head>

<body>
  <div id="map"></div>

  <!-- Info box (providers + totals) -->
  <div id="info-box">
    <strong>Visible Providers</strong><br>
    <div id="provider-count">Providers: 0</div>
    <div id="member-total">Total Members: 0</div>
  </div>

  <!-- Legend -->
  <div id="legend">
    <div class="legend-title">By Affiliation</div>
    <div class="legend-item"><div class="legend-color" style="background:#1f77b4;"></div>Main Line</div>
    <div class="legend-item"><div class="legend-color" style="background:#ff7f0e;"></div>Jefferson</div>
    <div class="legend-item"><div class="legend-color" style="background:#9467bd;"></div>St. Luke's</div>
    <div class="legend-item"><div class="legend-color" style="background:#d62728;"></div>Tandigm</div>
    <div class="legend-item"><div class="legend-color" style="background:#2ca02c;"></div>UPenn</div>

    <br>
    <div class="legend-title">Attributed Members = Circle Size</div>
    <div class="legend-item">
      <div class="legend-color" style="width:8px;height:8px;background:#999;"></div> Smallest
    </div>
    <div class="legend-item">
      <div class="legend-color" style="width:22px;height:22px;background:#999;"></div> Largest
    </div>
  </div>

  <script>
    let map;
    let circles = [];
    let geojsonData;

    // Affiliation â†’ Color
    const colorMap = {
      "Main Line": "#1f77b4",
      "Jefferson": "#ff7f0e",
      "St. Luke's": "#9467bd",
      "Tandigm": "#d62728",
      "UPenn": "#2ca02c"
    };

    async function initMap() {
      map = new google.maps.Map(document.getElementById('map'), {
        center: { lat: 40.0, lng: -75.2 },
        zoom: 9,
        mapTypeId: 'roadmap'
      });

      // Load GeoJSON
      try {
        const response = await fetch("data.geojson");
        geojsonData = await response.json();
        renderCircles();
        updateInfoBox();
      } catch (err) {
        alert("Could not load data.geojson. Check file path or format.");
      }

      // Update sizes on zoom
      map.addListener("zoom_changed", () => {
        updateCircleSizes();
      });

      // Update totals when map moves
      map.addListener("idle", () => {
        updateInfoBox();
      });
    }

    function renderCircles() {
      geojsonData.features.forEach(feature => {
        const props = feature.properties;
        const coords = feature.geometry.coordinates;

        const affiliation = props["Affiliation"];
        const members = props["Member Attribution"];

        const circle = new google.maps.Circle({
          strokeColor: colorMap[affiliation] || "#666",
          strokeOpacity: 0.9,
          strokeWeight: 1,
          fillColor: colorMap[affiliation] || "#666",
          fillOpacity: 0.55,
          map,
          center: { lat: coords[1], lng: coords[0] },
          radius: scaleRadius(members)
        });

        const content = `
          <div style="font-size:14px;">
            <strong>${props["Provider / Facility"]}</strong><br>
            ${props.Address}, ${props.City}, ${props.State} ${props.Zip}<br>
            <strong>Affiliation:</strong> ${affiliation}<br>
            <strong>Members:</strong> ${members}
          </div>
        `;

        const infowindow = new google.maps.InfoWindow({ content });

        circle.addListener("click", () => {
          infowindow.setPosition(circle.getCenter());
          infowindow.open(map);
        });

        circles.push({ circle, members, affiliation });
      });
    }

    function scaleRadius(memberCount) {
      const zoom = map.getZoom();
      return memberCount * (zoom * 20);
    }

    function updateCircleSizes() {
      circles.forEach(obj => {
        obj.circle.setRadius(scaleRadius(obj.members));
      });
    }

    function updateInfoBox() {
      const bounds = map.getBounds();
      if (!bounds) return;

      let visibleCount = 0;
      let totalMembers = 0;

      circles.forEach(obj => {
        if (bounds.contains(obj.circle.getCenter())) {
          visibleCount++;
          totalMembers += obj.members;
        }
      });

      document.getElementById("provider-count").textContent =
        `Providers: ${visibleCount}`;
      document.getElementById("member-total").textContent =
        `Total Members: ${totalMembers.toLocaleString()}`;
    }
  </script>

  <script async
    src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDA3kRQCQIWUxnsE1b0__QSyCfFKkHwN8A&callback=initMap">
  </script>

</body>
</html>
